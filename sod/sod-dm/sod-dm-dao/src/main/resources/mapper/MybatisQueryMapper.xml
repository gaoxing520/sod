<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.piesat.dm.mapper.MybatisQueryMapper">

    <!--根据目录查询资料-->
    <select id="getDataClassListBYIn" resultType="java.util.Map">
        <bind name="pattern" value="'%' + className + '%'"/>
        <bind name="pattern" value="'%' + dDataId + '%'"/>
        select
        A.data_class_id,A.class_name,A.parent_id,A.type,A.d_data_id,A.meta_data_name,A.is_all_line,A.use_base_info,B.id
        logic_id,B.logic_flag,B.storage_type,B.database_id,B.is_complete,C.database_name,C.schema_name,C.database_classify,C.stop_use,C.database_define_id,D.database_name
        database_name_f,D.database_instance,D.database_type,E.logic_name
        from T_SOD_DATA_CLASS A
        left join T_SOD_DATA_LOGIC B on A.data_class_id = B.data_class_id
        left join T_SOD_LOGIC_DEFINE E on B.logic_flag=E.logic_flag
        left join T_SOD_DATABASE C on B.database_id=C.id
        left join T_SOD_DATABASE_DEFINE D on C.database_define_id = D.id
        WHERE
        A.data_class_id in
        <foreach collection="classIds" index="index" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        <if test="className != null and className != ''">
            AND class_name like #{pattern}
        </if>
        <if test="dDataId != null and dDataId != ''">
            AND A.d_data_id like #{pattern1}
        </if>
    </select>
    <!--根据物理库查询dataLogic（MAP）-->
    <select id="getDataLogicByDatabaseId" parameterType="String" resultType="java.util.Map">
        SELECT A.*,B.D_DATA_ID,B.CLASS_NAME,B.META_DATA_NAME
        FROM T_SOD_DATA_LOGIC A
        LEFT JOIN T_SOD_DATA_CLASS B ON A.DATA_CLASS_ID = B.DATA_CLASS_ID WHERE A.DATABASE_ID = #{databaseId}
    </select>

    <!--查询存储结构概览-->
    <select id="selectStorageConfigurationPageList" parameterType="java.util.Map" resultType="java.util.Map">
        select *,e.database_name special_database_name,ee.database_name database_name
        from t_sod_data_class f
        left join t_sod_data_logic a on (a.DATA_CLASS_ID = f.DATA_CLASS_ID AND f.type = 2 )
        left join t_sod_database e on a.DATABASE_ID = e.id
        left join t_sod_database_define ee on e.database_define_id = ee.id
        left join t_sod_storage_configuration h on (a.DATA_CLASS_ID = h.DATA_CLASS_ID AND a.LOGIC_flag=h.LOGIC_ID AND e.id=h.DATABASE_ID)
        left join t_sod_logic_define c on a.logic_flag = c.logic_flag
        left join t_sod_data_table b on (a.id = b.CLASS_LOGIC_ID <if test="map.queryTable == true"> AND b.DB_TABLE_TYPE = 'E' </if>)
        <if test="map.queryTable == false">
        left join t_sod_data_table_column g on b.id = g.table_id
        </if>
        <where>
            <if test="map.database_name != null and map.database_name  != ''">
                AND ee.database_name like '${map.database_name}%'
            </if>
            <if test="map.special_database_name != null and map.special_database_name  != ''">
                AND e.database_name like '${map.special_database_name}%'
            </if>
            <if test="map.class_name != null and map.class_name  != ''">
                AND f.class_name like '${map.class_name}%'
            </if>
            <if test="map.parent_id != null and map.parent_id  != ''">
                AND f.data_class_id like '${map.parent_id}%'
            </if>
            <if test="map.d_data_id != null and map.d_data_id  != ''">
                AND b.d_data_id like '${map.d_data_id}%'
            </if>
            <if test="map.logic_name != null and map.logic_name  != ''">
                AND c.logic_name like '${map.logic_name}%'
            </if>
        </where>
    </select>
    <!--修改存储结构概览状态-->
    <update id="updateStorageConfigurationStatus">
        update t_sod_storage_configuration set  ${column} = ${value} where  id = #{id}
    </update>
    <!--修改存储结构概览状态-->
    <select id="getByDatabaseIdAndTableName">
        select a.* from  t_sod_data_table a, t_sod_data_logic b where a.class_logic_id = b.id and a.table_name=#{tableName} and b.database_id = #{databaseId}
    </select>

    <!--在线时间检索条件分页查询-->
    <select id="onLineList" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT AA.DATA_CLASS_ID DATA_CLASS_ID,AA.D_DATA_ID D_DATA_ID,AA.IF_STOP_USE,AA.CLASS_NAME,CC.BEGIN_TIME,CC.END_TIME,CC.RECORD_COUNT
        FROM T_SOD_DATA_CLASS AA
        INNER JOIN
        (SELECT DATA_CLASS_ID,MAX(STATISTIC_TIME) STATISTIC_TIME FROM T_SOD_TABLEDATA_STATISTICS A LEFT JOIN
        T_SOD_DATA_TABLE B ON A.TABLE_ID = B.ID LEFT JOIN  T_SOD_DATA_LOGIC C ON B.class_logic_id = C.ID WHERE C.DATA_CLASS_ID IS NOT NULL GROUP BY C.DATA_CLASS_ID) BB ON
        AA.DATA_CLASS_ID = BB.DATA_CLASS_ID
        INNER JOIN (SELECT  distinct BEGIN_TIME,END_TIME,RECORD_COUNT,DATA_CLASS_ID,STATISTIC_TIME FROM T_SOD_TABLEDATA_STATISTICS A LEFT JOIN
        T_SOD_DATA_TABLE B ON A.TABLE_ID = B.ID LEFT JOIN T_SOD_DATA_LOGIC C ON B.class_logic_id = C.ID) CC ON (BB.DATA_CLASS_ID = CC.DATA_CLASS_ID AND
        BB.STATISTIC_TIME = CC.STATISTIC_TIME)
        <where>
            <if test="map.class_name != null and map.class_name != ''">
                AA.CLASS_NAME like '%${map.class_name}%'
            </if>
            <if test="map.d_data_id != null and map.d_data_id != ''">
                AND AA.D_DATA_ID like '%${map.d_data_id}%'
            </if>
        </where>
    </select>

</mapper>